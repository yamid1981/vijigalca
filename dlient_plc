<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>PLC Diagnostic</title>
<style>
body { font-family: 'Segoe UI', sans-serif; background: #0f172a; color: #f8fafc; margin: 10px; display: flex; flex-direction: column; align-items: center; }
.main-container { width: 100%; max-width: 800px; display: flex; flex-direction: column; gap: 15px; }
.card { background: #1e293b; border-radius: 12px; padding: 15px; border: 1px solid #334155; box-shadow: 0 4px 6px rgba(0,0,0,0.3); }
h3 { color: #38bdf8; margin: 0 0 10px 0; font-size: 1.1em; border-bottom: 1px solid #334155; padding-bottom: 5px; display: flex; justify-content: space-between; }
.bits-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(90px, 1fr)); gap: 6px; }
.bit-box { font-size: 10px; padding: 6px 2px; text-align: center; border-radius: 6px; background: #334155; color: #94a3b8; cursor: help; transition: 0.2s; }
.bit-box.active { background: #22c55e; color: white; box-shadow: 0 0 8px rgba(34, 197, 94, 0.3); }
.reg-table { width: 100%; border-collapse: collapse; font-family: 'Cascadia Code', monospace; font-size: 13px; }
.reg-table tr:hover { background: #2d3e5a !important; cursor: help; }
.reg-table td { padding: 8px; border-bottom: 1px solid #334155; }
.reg-idx { color: #64748b; font-weight: bold; width: 60px; }
.reg-name { color: #94a3b8; text-align: left; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 250px; }
.reg-val { color: #fbbf24; text-align: right; font-weight: bold; font-size: 1.1em; }
#status-bar { width: 100%; max-width: 800px; padding: 10px; border-radius: 8px; margin-bottom: 10px; text-align: center; font-weight: bold; background: #065f46; color: #34d399; transition: 0.5s; }
.scroll { max-height: 600px;  overflow-y: auto;  border: 1px solid #334155;  border-radius: 4px; }
.reg-table td { padding: 4px 8px;  border-bottom: 1px solid #334155; }
.reg-table td:nth-child(4) {    max-width: 220px;    white-space: normal;    color: #94a3b8;}
.reg-val {    min-width: 80px;}
</style>
</head>
<body>
<div id="status-bar">–°–≤—è–∑—å —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è...</div>
<div id="plc_time" style="padding-block: 1em;"></div>
    <button id="update-button" style="background-color: #22c55e; color: white; padding: 10px 20px; border-radius: 6px; cursor: pointer;">–û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ</button>
<!-- X -->
<div class="main-container">
        <div class="card">
            <h3>–í—Ö–æ–¥—ã <span>(X)</span></h3>
            <div id="rx-container" class="bits-grid"></div></div>
<!-- Y -->
<div class="card">
            <h3>–í—ã—Ö–æ–¥—ã <span>(Y)</span></h3>
            <div id="ry-container" class="bits-grid"></div></div>
<!-- C -->
<div class="card">
            <h3>–°—á–µ—Ç—á–∏–∫–∏<span>(C)</span></h3>
            <div class="scroll"><table id="rc-table" class="reg-table"></table></div></div>
<!-- L -->
<div class="card">
            <h3>–û—à–∏–±–∫–∏/–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è <span>(L)</span></h3>
            <div  style=" max-height: max-content;"><table id="rl-table" class="reg-table"></table></div></div>
<!-- M -->
<div class="card">
    <h3>–ü—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–µ –º–∞—Ä–∫–µ—Ä—ã <span>(M)</span></h3>
    <div class="scroll"><table id="rm-table" class="reg-table"></table></div></div>
<!-- D -->
<div class="card">
            <h3>–†–µ–≥–∏—Å—Ç—Ä—ã –¥–∞–Ω–Ω—ã—Ö <span>(D)</span></h3>
            <div class="scroll"><table id="rd-table" class="reg-table"></table></div></div>
<!-- SD -->
<div class="card">
            <h3>–†–µ–≥–∏—Å—Ç—Ä—ã —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö <span>(SD)</span></h3>
            <div class="scroll"><table id="rsd-table" class="reg-table"></table></div>
        </div>
</div>
<script>
var _sys_time="";
function decodeUtf16FromRegisters(regs) {
    const bytes = [];

    for (let i = 0; i < regs.length; i++) {
        const val = regs[i];
        const lo = val & 0xFF;
        const hi = (val >> 8) & 0xFF;
        bytes.push(lo, hi);
    }

    try {
        return new TextDecoder('utf-16le').decode(new Uint8Array(bytes));
    } catch {
        return null;
    }
}
function decodeStringBlock(arr, startIdx) {
    const bytes = [];

    for (let i = startIdx; i < arr.length; i++) {
        const val = arr[i].val;

        // –∫–æ–Ω–µ—Ü —Å—Ç—Ä–æ–∫–∏ (0x0000)
        if (val === 0) break;

        const lo = val & 0xFF;
        const hi = (val >> 8) & 0xFF;
        bytes.push(lo, hi);
    }

    try {
        return new TextDecoder('utf-16le').decode(new Uint8Array(bytes));
    } catch {
        return null;
    }
}
function filterTags(tags, type) {
    return tags.filter(t => t.type === type);
}
function fillTableRSD(arr) {
    const table = document.getElementById('rsd-table');
    table.innerHTML = '';
    arr.forEach(item => {
        let displayVal = item.val;
        let comment = '';
        const idx = item.addr;  // <-- –≥–ª–∞–≤–Ω–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ
        if (idx === 0) { comment = item.val === 0 ? '‚úî –ù–µ—Ç –æ—à–∏–±–æ–∫' : `–û—à–∏–±–∫–∞: ${item.val.toString(16).toUpperCase()}h`;} 
else if (idx === 200) {
    // SD200 ‚Äî CPU Switch Status
    if (item.val === 0) {
        comment = '‚úî –ö–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä –≤ —Ä–µ–∂–∏–º–µ RUN';
    } else if (item.val === 1) {
        comment = '‚ö†Ô∏è –ö–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä –≤ —Ä–µ–∂–∏–º–µ STOP';
    } else {
        comment = `??? –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ (${item.val})`;
    }
} else if (idx === 203) {
    // SD203 ‚Äî CPU Status (b0 RUN, b2 STOP, b3 PAUSE)
    const v = item.val;
    const isRun  = (v & 0b0001) !== 0;
    const isStop = (v & 0b0100) !== 0;
    const isPause = (v & 0b1000) !== 0;
    if (isRun) {
        comment = '‚úî CPU RUN (b0=1)';
    } else if (isStop) {
        comment = '‚ö†Ô∏è CPU STOP (b2=1)';
    } else if (isPause) {
        comment = '‚ö†Ô∏è CPU PAUSE (b3=1)';
    } else {
        // FX5U —á–∞—Å—Ç–æ –æ—Ç–¥–∞—ë—Ç SD203 = 0 –≤ RUN —Ä–µ–∂–∏–º–µ
        comment = '‚úî CPU RUN (–≤—Å–µ –±–∏—Ç—ã = 0)';
    }
} else if (idx === 600) {
    // SD600 ‚Äî SD Memory Card Installation / Enable
    if (item.val === 64) {
        comment = '‚úî SD‚Äë–∫–∞—Ä—Ç–∞ –≤—Å—Ç–∞–≤–ª–µ–Ω–∞ –∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞ (0x0040)';
    } else if (item.val === 0) {
        comment = '‚ö†Ô∏è SD‚Äë–∫–∞—Ä—Ç–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –∏–ª–∏ –æ—Ç–∫–ª—é—á–µ–Ω–∞';
    } else {
        comment = `??? –ù–µ–æ–∂–∏–¥–∞–Ω–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ SD600 (${item.val})`;
    }
}
else if (idx === 604) {
    if (item.val === 0) {
        comment = '‚úî SD‚Äë–∫–∞—Ä—Ç–∞ –≤ —Ä–∞–±. —Ä–µ–∂–∏–º–µ';
    } else if (item.val === 1) {
        comment = '‚è≥ SD‚Äë–∫–∞—Ä—Ç–∞: –æ–ø–µ—Ä–∞—Ü–∏—è —á—Ç–µ–Ω–∏—è';
    } else if (item.val === 2) {
        comment = 'üíæ SD‚Äë–∫–∞—Ä—Ç–∞: –æ–ø–µ—Ä–∞—Ü–∏—è –∑–∞–ø–∏—Å–∏';
    } else {
        comment = `‚ö†Ô∏è –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ SD604 (${item.val})`;
    }
}
else if (idx === 210) {
    comment = '‚è∞ –°–∏—Å—Ç–µ–º–Ω—ã–µ —á–∞—Å—ã PLC - –≥–æ–¥';
    _sys_time +=`             –í—Ä–µ–º—è –≤ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–µ  ${item.val}-`;
}
else if (idx === 211) {
    comment = '‚è∞ –°–∏—Å—Ç–µ–º–Ω—ã–µ —á–∞—Å—ã PLC - –º–µ—Å';
    _sys_time += `${item.val}-`;
}
else if (idx === 212) {
    comment = '‚è∞ –°–∏—Å—Ç–µ–º–Ω—ã–µ —á–∞—Å—ã PLC - –¥–µ–Ω—å';
    _sys_time += `${item.val} `;
}
else if (idx === 213) {
    comment = '‚è∞ –°–∏—Å—Ç–µ–º–Ω—ã–µ —á–∞—Å—ã PLC - —á–∞—Å';
    _sys_time += ` ${item.val}:`;
}
else if (idx === 214) {
    comment = '‚è∞ –°–∏—Å—Ç–µ–º–Ω—ã–µ —á–∞—Å—ã PLC - –º–∏–Ω';
    _sys_time +=`${item.val}:`;
}
else if (idx === 215) {
    comment = '‚è∞ –°–∏—Å—Ç–µ–º–Ω—ã–µ —á–∞—Å—ã PLC - —Å–µ–∫';
    _sys_time += `${item.val}`;
}
else if (idx === 519) {
    comment = `Initial scan: ${item.val} ¬µs`;
}
else if (idx === 523) {
    comment = `Min scan: ${item.val} ¬µs`;
}
else if (idx === 524) {
    comment = `Max scan: ${item.val} ms`;
}
else if (idx === 525) {
    comment = `Max scan: ${item.val} ¬µs`;
}
        else if (idx === 606) {
            const low  = item.val;
            const high = arr.find(i => i.addr === 607)?.val || 0;
            const totalKB = (high * 65536) + low;
            displayVal = totalKB;
            comment = `‚âà ${(totalKB / 1024 / 1024).toFixed(2)} –ì–ë –≤—Å–µ–≥–æ`;} 
        else if (idx === 610) {
            const low  = item.val;
            const high = arr.find(i => i.addr === 611)?.val || 0;
            const freeKB = (high * 65536) + low;
            displayVal = freeKB;
            comment = `‚âà ${(freeKB / 1024).toFixed(1)} –ú–ë —Å–≤–æ–±–æ–¥–Ω–æ`;
            if (freeKB < 50000) comment += ' ‚ö†Ô∏è –ú–∞–ª–æ –º–µ—Å—Ç–∞!';}
        if (!item.name && item.val === 0) return;
        const row = document.createElement('tr');
        row.innerHTML = `
            <td class="reg-idx">SD${idx}</td>
            <td class="reg-name">${item.name || '‚Äî'}</td>
            <td class="reg-val">${displayVal}</td>
            <td style="color:#94a3b8; font-size:0.9em;">${comment}</td>
        `;
        table.appendChild(row);
    });
}
function toOctal(idx) {
            let dec = parseInt(idx);
            return (Math.floor(dec / 8) * 10 + (dec % 8)).toString();
        }
function formatTime(seconds) {
    if (!seconds || seconds < 0) return "0:00:00";
    const h = Math.floor(seconds / 3600);
    const m = Math.floor((seconds % 3600) / 60);
    const s = seconds % 60;
    // –§–æ—Ä–º–∞—Ç –ß:–ú–ú:–°–° (–∫–∞–∫ –≤ —Ç–≤–æ–µ–º WinForm)
    return `${h}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
}
function fillTableRM(arr) {
    const table = document.getElementById('rm-table');
    table.innerHTML = '';
    arr.forEach(item => {
        if (!item.name) return;
        const row = document.createElement('tr');
        row.innerHTML = `
            <td class="reg-idx">M${item.addr}</td>
            <td class="reg-name">${item.name || '---'}</td>
            <td class="reg-val">${item.val}</td>
        `;
        table.appendChild(row);
    });
}
async function update() {
    try {
        _sys_time="";
        const res = await fetch('/plc_get');
        const data = await res.json();
        const plc = data.PLC_01;
        if (!plc) throw new Error();
        const tags = plc.tags;
        const rx = filterTags(tags, "RX");
        const ry = filterTags(tags, "RY");
        const rc = filterTags(tags, "RC");
        const rl = filterTags(tags, "RL");
        const rm = filterTags(tags, "RM");
        const rd = filterTags(tags, "RD");
        const sd = filterTags(tags, "SD");
        // RX –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è
        document.getElementById('rx-container').innerHTML = rx.map(item => {
            let oct = 'X' + toOctal(item.addr);
            let fullName = item.name || oct;
            return `<div class="bit-box ${item.val ? 'active' : ''}" title="${fullName}">
                        <b>${item.name ? item.name.substring(0, 10) + '..' : oct}</b><br>
                        <span style="opacity:0.6">${oct}</span>
                    </div>`;
        }).join('');
        // RY –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è
        document.getElementById('ry-container').innerHTML = ry.map(item => {
            let oct = 'Y' + toOctal(item.addr);
            let fullName = item.name || oct;
            return `<div class="bit-box ${item.val ? 'active' : ''}" title="${fullName}">
                        <b>${item.name ? item.name.substring(0, 10) + '..' : oct}</b><br>
                        <span style="opacity:0.6">${oct}</span>
                    </div>`;
        }).join('');
        fillTable('rc-table', rc, 'C');
        fillTable('rl-table', rl, 'L');
        fillTable('rd-table', rd, 'D');
        fillTableRM(rm);
        fillTableRSD(sd);
        const status = document.getElementById('status-bar');
        status.style.background = "#065f46";
        status.innerText = "–û–ë–ù–û–í–õ–ï–ù–û: " + new Date().toLocaleTimeString();
        document.getElementById('plc_time').textContent=_sys_time;
    } catch(e) { 
        const status = document.getElementById('status-bar');
        status.style.background = "#451a1a";
        status.innerText = "–ù–ï–¢ –°–í–Ø–ó–ò –° –ü–õ–ö";
    }
}
function fillTable(id, arr, prefix) {
    const table = document.getElementById(id);
    table.innerHTML = '';

    if (prefix === 'C') {
        const rcOrder = [30,31,32,33,34,35,36,37,40,41,42,44,45,46,50,101,102,103,104,110];
        
        rcOrder.forEach(targetIdx => {
            const item = arr.find(i => i.addr === targetIdx);
            if (!item) return;

            let displayVal = [101,102,103,104,110].includes(targetIdx) 
                ? item.val 
                : formatTime(item.val);

            let valueColor = item.val > 0 ? '#fbbf24' : '#666';

            const row = document.createElement('tr');
            row.innerHTML = `
                <td class="reg-idx">C${targetIdx}</td>
                <td class="reg-name">${item.name || '---'}</td>
                <td class="reg-val" style="color: ${valueColor}">${displayVal}</td>
            `;
            table.appendChild(row);
        });
    } 
        else {  
        for (let i = 0; i < arr.length; i++) {
            const item = arr[i];
            // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –ø—É—Å—Ç—ã–µ, –µ—Å–ª–∏ –Ω–µ—Ç –∏–º–µ–Ω–∏ –∏ –∑–Ω–∞—á–µ–Ω–∏—è
            if (!item.name && item.val === 0) continue;

            let extraText = '';
            let skipCount = 0;

            // –õ–æ–≥–∏–∫–∞ —Å–∫–ª–µ–π–∫–∏
            if ((prefix === 'D' || item.type === 'RD') && item.val > 0) {
                let fullString = "";
                let j = i;

                while (j < arr.length && arr[j].val > 0) {
                    const lo = arr[j].val & 0xFF;
                    const hi = (arr[j].val >> 8) & 0xFF;
                    const bytes = new Uint8Array([lo, hi]);
                    const decoded = new TextDecoder('windows-1251').decode(bytes);
                    const clean = decoded.replace(/[\x00-\x1F\x7F]/g, '');
                    
                    if (clean.length === 0) break;
                    fullString += clean;
                    j++;
                    // –ï—Å–ª–∏ —É —Å–ª–µ–¥—É—é—â–µ–≥–æ —Ä–µ–≥–∏—Å—Ç—Ä–∞ –µ—Å—Ç—å —Å–≤–æ–µ –ò–º—è –≤ –ü–õ–ö ‚Äî –ø—Ä–µ—Ä—ã–≤–∞–µ–º —Å–∫–ª–µ–π–∫—É
                    if (j < arr.length && arr[j].name) break; 
                }

                if (fullString.trim().length > 1) {
                    extraText = `<span style="color:#86efac; font-weight:600; margin-left:12px; padding: 2px 6px; background: rgba(134, 239, 172, 0.1); border-radius: 4px;">
                                    "${fullString.trim()}"
                                 </span>`;
                    // –û–ü–†–ï–î–ï–õ–Ø–ï–ú, —Å–∫–æ–ª—å–∫–æ —Ä–µ–≥–∏—Å—Ç—Ä–æ–≤ –º—ã –ø–æ–≥–ª–æ—Ç–∏–ª–∏
                    skipCount = (j - i) - 1; 
                }
            }

            const row = document.createElement('tr');
            row.innerHTML = `
                <td class="reg-idx">${prefix}${item.addr}</td>
                <td class="reg-name">${item.name || '---'}</td>
                <td class="reg-val">${item.val} ${extraText}</td>
            `;
            table.appendChild(row);

            // –®–ê–ì –ü–ï–†–ï–•–û–î–ê: –ø—Ä–æ–ø—É—Å–∫–∞–µ–º —Ä–µ–≥–∏—Å—Ç—Ä—ã, –∫–æ—Ç–æ—Ä—ã–µ —É–∂–µ —Å—Ç–∞–ª–∏ —á–∞—Å—Ç—å—é —Å—Ç—Ä–æ–∫–∏
            if (skipCount > 0) {
                i += skipCount;
            }
        }
    }


}

document.getElementById('update-button').addEventListener('click', update);
update();
    </script>
</body>
</html>
