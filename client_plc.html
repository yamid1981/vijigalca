<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>PLC Diagnostic</title>
    <style>
        body {
            font-family: 'Segoe UI', sans-serif;
            background: #0f172a;
            color: #f8fafc;
            margin: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .main-container {
            width: 100%;
            max-width: 60em;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .card {
            background: #1e293b;
            border-radius: 12px;
            padding: 15px;
            border: 1px solid #334155;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }

        h3 {
            color: #38bdf8;
            margin: 0 0 10px 0;
            font-size: 1.1em;
            border-bottom: 1px solid #334155;
            padding-bottom: 5px;
            display: flex;
            justify-content: space-between;
        }

        .bits-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(90px, 1fr));
            gap: 6px;
        }

        .bit-box {
            font-size: 10px;
            padding: 6px 2px;
            text-align: center;
            border-radius: 6px;
            background: #334155;
            color: #94a3b8;
            cursor: help;
            transition: 0.2s;
        }

        .bit-box.active {
            background: #22c55e;
            color: white;
            box-shadow: 0 0 8px rgba(34, 197, 94, 0.3);
        }

        .reg-table {
            width: 100%;
            border-collapse: collapse;
            font-family: 'Cascadia Code', monospace;
            font-size: 13px;
        }

        .reg-table tr:hover {
            background: #2d3e5a !important;
            cursor: help;
        }

        .reg-table td {
            padding: 8px;
            border-bottom: 1px solid #334155;
        }

        .reg-idx {
            color: #64748b;
            font-weight: bold;
            width: 60px;
        }

        .reg-name {
            color: #94a3b8;
            text-align: left;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            max-width: 250px;
        }

        .reg-val {
            color: #fbbf24;
            text-align: right;
            font-weight: bold;
            font-size: 1.1em;
        }

        #status-bar {
            width: 100%;
            max-width: 800px;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 10px;
            text-align: center;
            font-weight: bold;
            background: #065f46;
            color: #34d399;
            transition: 0.5s;
        }

        .scroll {
            max-height: 600px;
            overflow-y: auto;
            border: 1px solid #334155;
            border-radius: 4px;
        }

        .reg-table td {
            padding: 4px 8px;
            border-bottom: 1px solid #334155;
        }

        .reg-table td:nth-child(4) {
            max-width: 220px;
            white-space: normal;
            color: #94a3b8;
        }

        .reg-val {
            min-width: 80px;
        }

        @keyframes pulse {
            0% {
                transform: scale(1);
                opacity: 1;
            }

            50% {
                transform: scale(1.2);
                opacity: 0.7;
            }

            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        .frd-table {
            width: 100%;
            border-collapse: collapse;
            font-family: Consolas, monospace;
            font-size: 14px;
            background: #0f172a;
            color: #e2e8f0;
        }

        .frd-table th {
            background: #1e293b;
            padding: 8px;
            border-bottom: 2px solid #334155;
            text-align: left;
        }

        .frd-table td {
            padding: 6px 8px;
            border-bottom: 1px solid #334155;
        }

        .frd-table tr:nth-child(even) {
            background: #1e2533;
        }

        .frd-table tr:hover {
            background: #334155;
        }

        .conveyor-card {
            background: linear-gradient(135deg, #1e3a5f, #0f2a4a);
            padding: 18px;
            border-radius: 14px;
            box-shadow: 0 6px 18px rgba(0, 0, 0, 0.35);
            color: #e5e7eb;
        }

        .card-title {
            margin: 0 0 14px 0;
            font-size: 1.4em;
            font-weight: 600;
            text-align: center;
        }

        .emoji {
            font-size: 1.2em;
        }

        .conveyor-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 18px;
            padding: 10px;
        }

        .sensor-block {
            text-align: center;
        }

        .sensor-block.wide {
            grid-column: span 2;
        }

        .indicator-circle {
            width: 70px;
            height: 70px;
            margin: 0 auto;
            border-radius: 50%;
            background: #374151;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 1.1em;
            color: #d1d5db;
            transition: 0.25s;
            box-shadow: inset 0 0 8px rgba(0, 0, 0, 0.4);
        }

        .indicator-circle.active {
            background: #22c55e;
            color: white;
            box-shadow: 0 0 12px #22c55e;
        }

        .indicator-circle.inactive {
            background: #ef4444;
            color: white;
            box-shadow: 0 0 12px #ef4444;
        }

        .direction-indicator {
            width: 80px;
            height: 80px;
            margin: 0 auto;
            border-radius: 50%;
            background: #374151;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2em;
            transition: 0.25s;
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.4);
        }

        .indicator-label {
            margin-top: 6px;
            font-size: 0.9em;
            opacity: 0.85;
        }

        .big-value {
            font-size: 2.4em;
            font-weight: bold;
            color: #fbbf24;
        }

        .medium-value {
            font-size: 1.8em;
            color: #f59e0b;
        }

        .chain-error {
            color: #f87171;
            text-align: center;
            margin-top: 12px;
            min-height: 1.2em;
        }
    </style>
</head>

<body>
    <div id="status-bar">–°–≤—è–∑—å —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è...</div>
    <div id="plc_time" style="padding-block: 1em;"></div>
    <button id="update-button"
        style="background-color: #22c55e; color: white; padding: 10px 20px; border-radius: 6px; cursor: pointer;">–û–±–Ω–æ–≤–∏—Ç—å
        –í–°–ï
        –¥–∞–Ω–Ω—ã–µ</button>
    <!-- X -->
    <div class="main-container">
        <div class="card">
            <h3>–í—Ö–æ–¥—ã <span>(X)</span></h3>
            <div id="rx-container" class="bits-grid"></div>
        </div>
        <div class="card conveyor-card">
            <h3 class="card-title">
                –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Ü–µ–ø–∏ –∫–æ–Ω–≤–µ–π–µ—Ä–∞ <span class="emoji">üîó‚ö°</span>
                <label style="display:flex; align-items:center; gap:8px; margin:10px 0;">
                    <input type="checkbox" id="poll-x-checkbox" checked>
                    –û–ø—Ä–æ—Å Online 500–º—Å
                </label>
            </h3>

            <div class="conveyor-grid">

                <div class="sensor-block" style="margin-top: 2em;">
                    <div class="indicator-circle" id="_X25">X25</div>
                    <div class="indicator-label">–ù–∞—á–∞–ª–æ –∑–≤–µ–Ω–∞</div>
                </div>

                <div class="sensor-block" style="margin-top: 2em;">
                    <div class="indicator-circle" id="_X24">X24</div>
                    <div class="indicator-label">–ö–æ–Ω–µ—Ü –∑–≤–µ–Ω–∞</div>
                </div>

                <div class="sensor-block" style="margin-top: 2em;">
                    <div class="indicator-circle">X22</div>
                    <div class="indicator-label" id="_X22">–¶–ï–ü–¨</div>
                </div>

                <div class="sensor-block wide">
                    <div class="big-value" id="C102">--</div>
                    <div class="indicator-label">–¢–µ–∫—É—â–µ–µ –∑–≤–µ–Ω–æ</div>

                    <div class="medium-value" id="D4000">--</div>
                    <div class="indicator-label">–ü–µ—Ä–µ–∑–∞–ø—É—Å–∫</div>
                </div>

            </div>

            <div id="chain-error" class="chain-error"></div>
        </div>
        <!-- Y -->
        <div class="card">
            <h3>–í—ã—Ö–æ–¥—ã <span>(Y)</span></h3>
            <div id="ry-container" class="bits-grid"></div>
        </div>

        <div class="card">
            <h3>–ó–∞–∫–ª–∞–¥–∫–∞,–æ—á–µ—Ä–µ–¥—å<span>(D)</span></h3>
            <table id="special-table" class="frd-table">
                <thead>
                    <tr>
                        <th></th>
                        <th>–ú–æ–¥–µ–ª—å</th>
                        <th>–ë–∞–∑–∞</th>
                        <th>–ó–≤–µ–Ω—å–µ–≤</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
        <!-- C -->
        <div class="card">
            <h3>–°—á–µ—Ç—á–∏–∫–∏<span>(C)</span></h3>
            <div class="scroll">
                <table id="rc-table" class="reg-table"></table>
            </div>
        </div>
        <!-- L -->
        <div class="card">
            <h3>–û—à–∏–±–∫–∏/–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è <span>(L)</span></h3>
            <div style=" max-height: max-content;">
                <table id="rl-table" class="reg-table"></table>
            </div>
        </div>
        <!-- M -->
        <div class="card">
            <h3>–ü—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–µ –º–∞—Ä–∫–µ—Ä—ã <span>(M)</span></h3>
            <div class="scroll">
                <table id="rm-table" class="reg-table"></table>
            </div>
        </div>
        <!-- D -->
        <div class="card">
            <h3>–†–µ–≥–∏—Å—Ç—Ä—ã –¥–∞–Ω–Ω—ã—Ö <span>(ALL D)</span></h3>
            <div class="scroll">
                <table id="rd-table" class="reg-table"></table>
            </div>
        </div>
        <!-- SD -->
        <div class="card">
            <h3>–†–µ–≥–∏—Å—Ç—Ä—ã —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö <span>(SD)</span></h3>
            <div class="scroll">
                <table id="rsd-table" class="reg-table"></table>
            </div>
        </div>
        <!-- FRD -->
        <div class="card">
            <h3>–§–∞–π–ª–æ–≤—ã–µ —Ä–µ–≥–∏—Å—Ç—Ä—ã —Å SD-–∫–∞—Ä—Ç—ã (–ø–∞–º—è—Ç—å –≤—ã—Ö–æ–¥–∞ –º–∞—à–∏–Ω) <span>(FRD)</span></h3>
            <div class="scroll">
                <table id="frd-table" class="frd-table">
                    <thead>
                        <tr>
                            <th>–î–∞—Ç–∞</th>
                            <th>–í—Ä–µ–º—è</th>
                            <th>–≠—Ç–∞–ø</th>
                            <th>‚Ññ<br>–≤—ã—Ö–æ–¥–∞</th>
                            <th>–ú–µ–∂–¥—É<br>–ü–µ—Ä–µ–¥–Ω.<br>–°—Ç–æ–π–∫.</th>
                            <th>–ú–æ–¥–µ–ª—å</th>
                            <th>–ë–∞–∑–∞</th>
                            <th>–ö–æ–ª-–≤–æ<br>–∑–≤–µ–Ω—å–µ–≤</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>
    <script>
        let xyRendered = false;
        const STAGES = [
            "–ü–û–î–í–ê–õ",
            "–ó–ê–ö–õ–ê–î–ö–ê",
            "–£–°–¢–ê–ù–û–í–ö–ê –ú–û–°–¢–ê",
            "–£–°–¢–ê–ù–û–í–ö–ê –ú–û–°–¢–ê",
            "–£–°–¢–ê–ù–û–í–ö–ê –û–°–¨/–ö–ê–†–î–ê–ù",
            "–£–°–¢.–°–ò–°–¢.–ù–ï–ô–¢–†–û–õ–ò–ó–ê–¶–ò–ò–ò",
            "–ü–ï–†–ï–í–û–†–û–¢ –†–ê–ú–´",
            "–£–°–¢.–†–£–õ–ï–í.–ú–ï–•–ê–ù.",
            "–£–°–¢.–†–£–õ–ï–í.–ú–ï–•–ê–ù.",
            "–£–°–¢–ê–ù–û–í–ö–ê –î–í–°",
            "–ó–ê–ü–†–ê–í–ö–ê –†–ê–ó–î.–ö–û–†–û–ë–ö–ò",
            "–£–°–¢–ê–ù–û–í–ö–ê –†–ê–î–ò–ê–¢–û–†–ê",
            "–£–°–¢.–°–ò–°–¢.–ù–ï–ô–¢–†–û–õ–ò–ó–ê–¶–ò–ò–ò",
            "–ó–ê–ü–†.–¶–ò–õ–ò–ù.–ü–û–î–™–ï–ú.–ö–ê–ë–ò–ù",
            "–£–°–¢–ê–ù.–ê–ö–ë –∏ –ë–ê–ö–ê",
            "–£–°–¢–ê–ù.–ê–ö–ë –∏ –ë–ê–ö–ê",
            "–£–°–¢–ê–ù–û–í–ö–ê –ö–û–õ–Å–°",
            "–£–°–¢–ê–ù–û–í–ö–ê –ö–û–õ–Å–°",
            "–£–°–¢–ê–ù–û–í–ö–ê –ö–û–õ–Å–°",
            "–£–°–¢–ê–ù–û–í–ö–ê –ö–ê–ë–ò–ù–´",
            "–£–°–¢–ê–ù.–°–ï–î-–°–¶–ï–ü–ù.–£–°–¢-–í–ê",
            "–£–°–¢–ê–ù. –ù–ê–î–†–ê–ú–ù–ò–ö–ê",
            "–£–°–¢–ê–ù. –û–ü–ï–†–ï–ù–ò–Ø",
            "–ó–ê–ü–†–ê–í–ö–ê –î–¢ –∏ –û–ñ",
            "–ó–ê–ü–†–ê–í–ö–ê –°–¶–ï–ü–õ–ï–ù–ò–Ø",
            "–ó–ê–í–û–î–ö–ê –ê–í–¢–û–ú–û–ë–ò–õ–Ø",
            "–ü–†–û–í–ï–†–ö–ê –¢–û–†–ú–û–ó–ù.–°–ò–°-–ú–´",
            "–ü–†–û–í–ï–†–ö–ê –°–¶–ï–ü–õ–ï–ù–ò–Ø",
            "–°–™–ï–ó–î –° –ö–û–ù–í–ï–ô–ï–†–ê"
        ];
        var _sys_time = "";
        let xyInterval = null;

        document.getElementById("poll-x-checkbox").addEventListener("change", function () {
            if (this.checked) {
                xyInterval = setInterval(plc_xy, 500);
                plc_xy();
            } else {
                clearInterval(xyInterval);
                xyInterval = null;
            }
        });

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ—Ç–∫–ª—é—á–µ–Ω–∏–µ –æ–ø—Ä–æ—Å–∞ –∏ —Å–Ω—è—Ç–∏–µ –≥–∞–ª–æ—á–∫–∏ –ø—Ä–∏ —Å–∫—Ä—ã—Ç–∏–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener("visibilitychange", () => {
            const checkbox = document.getElementById("poll-x-checkbox");

            if (document.hidden) {
                checkbox.checked = false;
                clearInterval(xyInterval);
                xyInterval = null;
            }
        });

        function readText(map, start, end) {
            let text = "";
            for (let addr = start; addr <= end; addr++) {
                const val = map[addr] ?? 0;
                const lo = val & 0xFF;
                const hi = (val >> 8) & 0xFF;

                let c1 = String.fromCharCode(lo);
                let c2 = String.fromCharCode(hi);

                if (c1.charCodeAt(0) < 32) c1 = ' ';
                if (c2.charCodeAt(0) < 32) c2 = ' ';

                text += c1 + c2;
            }
            return text.trim();
        }
        function readBlock(map, modelStart, baseStart, countAddr) {
            const model = readText(map, modelStart, modelStart + 10);
            const base = readText(map, baseStart, baseStart + 2);
            const count = map[countAddr] ?? 0;

            // –µ—Å–ª–∏ –≤—Å—ë –ø—É—Å—Ç–æ ‚Äî –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º
            if (!model && !base && !count) return null;

            return { model, base, count };
        }
        function readSpecialData(arr) {
            const map = {};
            for (const w of arr) map[w.addr] = w.val;

            return [
                { name: "–§–æ—Ä–º–∏—Ä—É–µ–º–∞—è", data: readBlock(map, 700, 711, 714) },
                { name: "–ó–∞–∫–ª–∞–¥–∫–∞ 1", data: readBlock(map, 2000, 2011, 2014) },
                { name: "–ó–∞–∫–ª–∞–¥–∫–∞ 2", data: readBlock(map, 2016, 2027, 2030) },
                { name: "–ó–∞–∫–ª–∞–¥–∫–∞ 3", data: readBlock(map, 2032, 2043, 2046) },
                { name: "–ó–∞–∫–ª–∞–¥–∫–∞ 4", data: readBlock(map, 2048, 2059, 2062) },
                { name: "–ó–∞–∫–ª–∞–¥–∫–∞ 5", data: readBlock(map, 2064, 2075, 2078) },
                { name: "–ó–∞–∫–ª–∞–¥–∫–∞ 6", data: readBlock(map, 2080, 2091, 2094) },
                { name: "–ó–∞–∫–ª–∞–¥–∫–∞ 7", data: readBlock(map, 2096, 2107, 2110) },
                { name: "–ó–∞–∫–ª–∞–¥–∫–∞ 8", data: readBlock(map, 2112, 2123, 2126) },
                { name: "–ó–∞–∫–ª–∞–¥–∫–∞ 9", data: readBlock(map, 2128, 2139, 2142) },
                { name: "–ó–∞–∫–ª–∞–¥–∫–∞ 10", data: readBlock(map, 2144, 2155, 2158) }
            ];
        }
        function fillSpecialTable(arr) {
            const tbody = document.querySelector('#special-table tbody');
            tbody.innerHTML = '';

            for (const item of arr) {
                if (!item.data) continue;

                const row = document.createElement('tr');
                row.innerHTML = `
            <td>${item.name}</td>
            <td>${item.data.model}</td>
            <td>${item.data.base}</td>
            <td>${item.data.count}</td>
        `;
                tbody.appendChild(row);
            }
        }
        function filterTags(tags, type) {
            return tags.filter(t => t.type === type);
        }
        function fillTableRSD(arr) {
            const table = document.getElementById('rsd-table');
            table.innerHTML = '';
            arr.forEach(item => {
                let displayVal = item.val;
                let comment = '';
                const idx = item.addr;  // <-- –≥–ª–∞–≤–Ω–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ
                if (idx === 0) { comment = item.val === 0 ? '‚úî –ù–µ—Ç –æ—à–∏–±–æ–∫' : `–û—à–∏–±–∫–∞: ${item.val.toString(16).toUpperCase()}h`; }
                else if (idx === 200) {
                    // SD200 ‚Äî –§–∏–∑–∏—á–µ—Å–∫–∏–π –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å
                    comment = (item.val === 0) ? '‚úî –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å –≤ RUN' : '‚ö†Ô∏è –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å –≤ STOP';
                }
                else if (idx === 201) {
                    // SD201 ‚Äî –°–æ—Å—Ç–æ—è–Ω–∏–µ —Å–≤–µ—Ç–æ–¥–∏–æ–¥–æ–≤ (–ë–∏—Ç–æ–≤–∞—è –º–∞—Å–∫–∞)
                    const v = item.val;
                    let leds = [];
                    if (v & 0x0004) leds.push('‚ùå ERR –≥–æ—Ä–∏—Ç');
                    if (v & 0x0008) leds.push('üõë ERR –º–∏–≥–∞–µ—Ç');
                    if (v & 0x0010) leds.push('üü¢ P.RUN –≥–æ—Ä–∏—Ç');
                    if (v & 0x0020) leds.push('üü° PAUSE');
                    if (v & 0x0200) leds.push('ü™´ BAT –º–∏–≥–∞–µ—Ç');
                    if (v & 0x1000) leds.push('üíæ SD-–∫–∞—Ä—Ç–∞ –≥–æ—Ç–æ–≤–∞');
                    if (v & 0x2000) leds.push('‚è≥ –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ SD-–∫–∞—Ä—Ç—ã');

                    comment = leds.length > 0 ? leds.join(' | ') : '–í—Å–µ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã –ø–æ–≥–∞—à–µ–Ω—ã';
                }
                else if (idx === 203) {
                    // SD203 ‚Äî –¢–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å CPU
                    if (item.val === 0) comment = 'üü¢ –°—Ç–∞—Ç—É—Å: RUN';
                    else if (item.val === 2) comment = '‚ö†Ô∏è –°—Ç–∞—Ç—É—Å: STOP';
                    else if (item.val === 3) comment = 'üü° –°—Ç–∞—Ç—É—Å: PAUSE';
                    else comment = `–°—Ç–∞—Ç—É—Å: ${item.val} (–ø–µ—Ä–µ—Ö–æ–¥–Ω—ã–π —Ä–µ–∂–∏–º)`;
                }
                else if (idx === 600) {
                    // SD600 ‚Äî SD Memory Card Installation / Enable
                    if (item.val === 64) {
                        comment = '‚úî SD‚Äë–∫–∞—Ä—Ç–∞ –≤—Å—Ç–∞–≤–ª–µ–Ω–∞ –∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞ (0x0040)';
                    } else if (item.val === 0) {
                        comment = '‚ö†Ô∏è SD‚Äë–∫–∞—Ä—Ç–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –∏–ª–∏ –æ—Ç–∫–ª—é—á–µ–Ω–∞';
                    } else {
                        comment = `??? –ù–µ–æ–∂–∏–¥–∞–Ω–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ SD600 (${item.val})`;
                    }
                }
                else if (idx === 604) {
                    if (item.val === 0) {
                        comment = '‚úî SD‚Äë–∫–∞—Ä—Ç–∞ –≤ —Ä–∞–±. —Ä–µ–∂–∏–º–µ';
                    } else if (item.val === 1) {
                        comment = '‚è≥ SD‚Äë–∫–∞—Ä—Ç–∞: –æ–ø–µ—Ä–∞—Ü–∏—è —á—Ç–µ–Ω–∏—è';
                    } else if (item.val === 2) {
                        comment = 'üíæ SD‚Äë–∫–∞—Ä—Ç–∞: –æ–ø–µ—Ä–∞—Ü–∏—è –∑–∞–ø–∏—Å–∏';
                    } else {
                        comment = `‚ö†Ô∏è –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ SD604 (${item.val})`;
                    }
                }
                else if (idx === 210) {
                    comment = '‚è∞ –°–∏—Å—Ç–µ–º–Ω—ã–µ —á–∞—Å—ã PLC - –≥–æ–¥';
                    _sys_time += `             –í—Ä–µ–º—è –≤ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–µ  ${item.val}-`;
                }
                else if (idx === 211) {
                    comment = '‚è∞ –°–∏—Å—Ç–µ–º–Ω—ã–µ —á–∞—Å—ã PLC - –º–µ—Å';
                    _sys_time += `${item.val}-`;
                }
                else if (idx === 212) {
                    comment = '‚è∞ –°–∏—Å—Ç–µ–º–Ω—ã–µ —á–∞—Å—ã PLC - –¥–µ–Ω—å';
                    _sys_time += `${item.val} `;
                }
                else if (idx === 213) {
                    comment = '‚è∞ –°–∏—Å—Ç–µ–º–Ω—ã–µ —á–∞—Å—ã PLC - —á–∞—Å';
                    _sys_time += ` ${item.val}:`;
                }
                else if (idx === 214) {
                    comment = '‚è∞ –°–∏—Å—Ç–µ–º–Ω—ã–µ —á–∞—Å—ã PLC - –º–∏–Ω';
                    _sys_time += `${item.val}:`;
                }
                else if (idx === 215) {
                    comment = '‚è∞ –°–∏—Å—Ç–µ–º–Ω—ã–µ —á–∞—Å—ã PLC - —Å–µ–∫';
                    _sys_time += `${item.val}`;
                }
                else if (idx === 519) {
                    comment = `Initial scan: ${item.val} ¬µs`;
                }
                else if (idx === 523) {
                    comment = `Min scan: ${item.val} ¬µs`;
                }
                else if (idx === 524) {
                    comment = `Max scan: ${item.val} ms`;
                }
                else if (idx === 525) {
                    comment = `Max scan: ${item.val} ¬µs`;
                }
                else if (idx === 606) {
                    const low = item.val;
                    const high = arr.find(i => i.addr === 607)?.val || 0;
                    const totalKB = (high * 65536) + low;
                    displayVal = totalKB;
                    comment = `‚âà ${(totalKB / 1024 / 1024).toFixed(2)} –ì–ë –≤—Å–µ–≥–æ`;
                }
                else if (idx === 610) {
                    const low = item.val;
                    const high = arr.find(i => i.addr === 611)?.val || 0;
                    const freeKB = (high * 65536) + low;
                    displayVal = freeKB;
                    comment = `‚âà ${(freeKB / 1024).toFixed(1)} –ú–ë —Å–≤–æ–±–æ–¥–Ω–æ`;
                    if (freeKB < 50000) comment += ' ‚ö†Ô∏è –ú–∞–ª–æ –º–µ—Å—Ç–∞!';
                }
                if (!item.name && item.val === 0) return;
                const row = document.createElement('tr');
                row.innerHTML = `
            <td class="reg-idx">SD${idx}</td>
            <td class="reg-name">${item.name || '‚Äî'}</td>
            <td class="reg-val">${displayVal}</td>
            <td style="color:#94a3b8; font-size:0.9em;">${comment}</td>
        `;
                table.appendChild(row);
            });
        }
        function toOctal(idx) {
            let dec = parseInt(idx);
            return (Math.floor(dec / 8) * 10 + (dec % 8)).toString();
        }
        function formatTime(seconds) {
            if (!seconds || seconds < 0) return "0:00:00";
            const h = Math.floor(seconds / 3600);
            const m = Math.floor((seconds % 3600) / 60);
            const s = seconds % 60;
            // –§–æ—Ä–º–∞—Ç –ß:–ú–ú:–°–° (–∫–∞–∫ –≤ —Ç–≤–æ–µ–º WinForm)
            return `${h}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
        }
        function fillTableRM(arr) {
            const table = document.getElementById('rm-table');
            table.innerHTML = '';
            arr.forEach(item => {
                if (!item.name) return;
                const row = document.createElement('tr');
                row.innerHTML = `
            <td class="reg-idx">M${item.addr}</td>
            <td class="reg-name">${item.name || '---'}</td>
            <td class="reg-val">${item.val}</td>
        `;
                table.appendChild(row);
            });
        }
        // –§—É–Ω–∫—Ü–∏—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏ (–æ—Ç—Ä–∏—Å–æ–≤–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤)
        function renderBitContainers(data) {
            if (xyRendered) return;
            xyRendered = true;
            const rx = data.filter(i => i.type === 'X');
            const ry = data.filter(i => i.type === 'Y');

            // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ X (–í—Ö–æ–¥—ã)
            document.getElementById('rx-container').innerHTML = rx.map(item => {
                const octName = `X${item.addr}`; // addr —É–∂–µ "0", "10" –∏ —Ç.–¥.
                return `
<div class="bit-box ${item.val ? 'active' : ''}" 
     data-type="X" 
     data-addr="${item.addr}" 
     title="${octName}">
    <b>${octName}</b><br>
    <span style="opacity:0.6">${item.val ? 'ON' : 'OFF'}</span>
</div>`;
            }).join('');

            // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ Y (–í—ã—Ö–æ–¥—ã)
            document.getElementById('ry-container').innerHTML = ry.map(item => {
                const octName = `Y${item.addr}`;
                return `
<div class="bit-box ${item.val ? 'active' : ''}" 
     data-type="Y" 
     data-addr="${item.addr}" 
     title="${octName}">
    <b>${octName}</b><br>
    <span style="opacity:0.6">${item.val ? 'ON' : 'OFF'}</span>
</div>`;
            }).join('');
        }
        var pereresovka = false;
        async function update() {
            try {
                if (pereresovka) return;
                pereresovka = true;
                _sys_time = "";
                const res = await fetch('/plc_get');
                const data = await res.json();
                const plc = data.PLC_01;
                if (!plc) throw new Error();
                const tags = plc.tags;
                const rx = filterTags(tags, "RX");
                const ry = filterTags(tags, "RY");
                const rc = filterTags(tags, "RC");
                const rl = filterTags(tags, "RL");
                const rm = filterTags(tags, "RM");
                const rd = filterTags(tags, "RD");
                const sd = filterTags(tags, "SD");
                const frd = filterTags(tags, "FRD");

                // RX –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è
                document.getElementById('rx-container').innerHTML = rx.map(item => {
                    let oct = 'X' + toOctal(item.addr);
                    let fullName = item.name || oct;
                    return `
        <div id="${oct}" 
             class="bit-box ${item.val ? 'active' : ''}"
             data-addr="${item.addr}"
             title="${fullName}">
            <b>${item.name ? item.name.substring(0, 10) + '..' : oct}</b><br>
            <span style="opacity:0.6">${oct}</span>
        </div>`;
                }).join('');

                // RY –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è
                document.getElementById('ry-container').innerHTML = ry.map(item => {
                    let oct = 'Y' + toOctal(item.addr);
                    let fullName = item.name || oct;
                    return `
        <div id="${oct}" 
             class="bit-box ${item.val ? 'active' : ''}" 
             title="${fullName}">
            <b>${item.name ? item.name.substring(0, 10) + '..' : oct}</b><br>
            <span style="opacity:0.6">${oct}</span>
        </div>`;
                }).join('');


                fillTable('rc-table', rc, 'C');
                fillTable('rl-table', rl, 'L');
                fillTable('rd-table', rd, 'D');
                fillTableRM(rm);
                fillTableRSD(sd);
                fillTableFRD(frd);

                const special = readSpecialData(rd);
                fillSpecialTable(special);

                const status = document.getElementById('status-bar');
                status.style.background = "#065f46";
                status.innerText = "–û–ë–ù–û–í–õ–ï–ù–û: " + new Date().toLocaleTimeString();
                document.getElementById('plc_time').textContent = _sys_time;
            } catch (e) {
                const status = document.getElementById('status-bar');
                status.style.background = "#451a1a";
                status.innerText = "–ù–ï–¢ –°–í–Ø–ó–ò –° –ü–õ–ö";
            }
        }
        function fillTable(id, arr, prefix) {
            const table = document.getElementById(id);
            table.innerHTML = '';

            if (prefix === 'C') {
                const rcOrder = [30, 31, 32, 33, 34, 35, 36, 37, 40, 41, 42, 44, 45, 46, 50, 101, 102, 103, 104, 110];

                rcOrder.forEach(targetIdx => {
                    const item = arr.find(i => i.addr === targetIdx);
                    if (!item) return;

                    let displayVal;
                    if (targetIdx < 100) {
                        const formatted = formatTime(item.val);
                        displayVal = `
                    <div style="display: flex; justify-content: space-between; align-items: center; gap: 15px;">
                        <span style="min-width: 70px; text-align: left;">${formatted}</span>
                        <span style="font-size: 0.85em; opacity: 0.5; font-family: monospace;">[${item.val}]</span>
                    </div>`;
                    } else {
                        displayVal = `<b>${item.val}</b>`;
                    }

                    let valueColor = item.val > 0 ? '#fbbf24' : '#666';

                    const row = document.createElement('tr');

                    // –î–û–ë–ê–í–õ–ï–ù–û: –ø–æ–¥—Å–∫–∞–∑–∫–∞ –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ –Ω–∞ –≤—Å—é —Å—Ç—Ä–æ–∫—É
                    if (item.name) row.title = item.name;

                    row.innerHTML = `
                <td class="reg-idx">C${targetIdx}</td>
                <td class="reg-name">${item.name || '---'}</td>
                <td class="reg-val" style="color: ${valueColor}; padding-right: 10px;">${displayVal}</td>
            `;
                    table.appendChild(row);
                });

            } else {
                for (let i = 0; i < arr.length; i++) {
                    const item = arr[i];
                    if (item.val === 0) continue;

                    let extraText = '';
                    let skipCount = 0;
                    let displayVal = item.val;

                    if (prefix === 'L') {
                        const isTrue = item.val === true || item.val === 1 || String(item.val).toLowerCase() === 'true';
                        if (isTrue) {
                            displayVal = `
                        <div style="display: flex; align-items: center; justify-content: flex-end; color: #ef4444; font-weight: bold;">
                            <span>TRUE</span>
                            <span style="margin-left: 8px; background: #ef4444; color: white; border-radius: 50%; width: 18px; height: 18px; display: flex; align-items: center; justify-content: center; font-size: 12px; animation: pulse 1.5s infinite;">!</span>
                        </div>`;
                        } else {
                            displayVal = `<span style="opacity: 0.5;">false</span>`;
                        }
                    }
                    else if ((prefix === 'D' || item.type === 'RD') && item.val > 0) {
                        let fullString = "";
                        let j = i;
                        while (j < arr.length && arr[j].val > 0) {
                            const lo = arr[j].val & 0xFF;
                            const hi = (arr[j].val >> 8) & 0xFF;
                            const bytes = new Uint8Array([lo, hi]);
                            const decoded = new TextDecoder('windows-1251').decode(bytes);
                            const clean = decoded.replace(/[\x00-\x1F\x7F]/g, '');
                            if (clean.length === 0) break;
                            fullString += clean;
                            j++;
                            if (j < arr.length && arr[j].name) break;
                        }
                        const finalStr = fullString.trim();
                        if (finalStr.length > 0) {
                            extraText = `<span style="color:#86efac; font-weight:600; margin-left:12px; padding: 2px 6px; background: rgba(134, 239, 172, 0.1); border-radius: 4px;">"${finalStr}"</span>`;
                            skipCount = j - i - 1;
                        }
                    }

                    const row = document.createElement('tr');

                    // –î–û–ë–ê–í–õ–ï–ù–û: –ø–æ–¥—Å–∫–∞–∑–∫–∞ –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ –Ω–∞ –≤—Å—é —Å—Ç—Ä–æ–∫—É
                    if (item.name) row.title = item.name;

                    if (prefix === 'L' && (item.val === true || item.val === 1)) {
                        row.style.background = "rgba(239, 68, 68, 0.05)";
                    }

                    row.innerHTML = `
                <td class="reg-idx">${prefix}${item.addr}</td>
                <td class="reg-name">${item.name || '---'}</td>
                <td class="reg-val">${prefix === 'L' ? displayVal : (item.val + extraText)}</td>
            `;
                    table.appendChild(row);

                    if (skipCount > 0) i += skipCount;
                }
            }
        }
        function fillTableFRD(arr) {
            const tbody = document.querySelector('#frd-table tbody');
            tbody.innerHTML = '';

            arr = arr.sort((a, b) => a.addr - b.addr);

            const map = {};
            for (const w of arr) map[w.addr] = w.val;

            const START = 24;
            const BLOCK = 24;

            const MODEL_START = 8;
            const MODEL_END = 18;

            const BASE_START = 19;
            const BASE_END = 21;

            const maxAddr = Math.max(...arr.map(x => x.addr));

            for (let base = START; base + BLOCK <= maxAddr; base += BLOCK) {

                // –ø—É—Å—Ç–∞—è –∑–∞–ø–∏—Å—å ‚Äî –ø—Ä–æ–ø—É—Å–∫–∞–µ–º
                if (!map[base] && !map[base + 1] && !map[base + 2]) continue;

                // ‚Üê‚Üê‚Üê –í–û–¢ –¢–£–¢ –î–û–õ–ñ–ù–û –ë–´–¢–¨!
                const w = (base - START) / BLOCK;
                const stage = (w < 29) ? STAGES[w] : "–í—ã–ø—É—â–µ–Ω–∞";

                const year = map[base + 0];
                const month = map[base + 1];
                const day = map[base + 2];
                const hour = map[base + 3];
                const minute = map[base + 4];
                const second = map[base + 5];
                const N = map[base + 6];
                const PP = map[base + 7];

                // --- –º–æ–¥–µ–ª—å ---
                let model = "";
                for (let i = MODEL_START; i <= MODEL_END; i++) {
                    const val = map[base + i];
                    const lo = val & 0xFF;
                    const hi = (val >> 8) & 0xFF;

                    let c1 = String.fromCharCode(lo);
                    let c2 = String.fromCharCode(hi);

                    if (c1.charCodeAt(0) < 32) c1 = ' ';
                    if (c2.charCodeAt(0) < 32) c2 = ' ';

                    model += c1 + c2;
                }
                model = model.trim();

                // --- –±–∞–∑–∞ ---
                let baseName = "";
                for (let i = BASE_START; i <= BASE_END; i++) {
                    const val = map[base + i];
                    const lo = val & 0xFF;
                    const hi = (val >> 8) & 0xFF;

                    let c1 = String.fromCharCode(lo);
                    let c2 = String.fromCharCode(hi);

                    if (c1.charCodeAt(0) < 32) c1 = ' ';
                    if (c2.charCodeAt(0) < 32) c2 = ' ';

                    baseName += c1 + c2;
                }
                baseName = baseName.trim();

                const count = map[base + 22];

                const dateStr = `${year}/${month}/${day}`;
                const timeStr = `${hour}:${minute}:${second}`;

                const row = document.createElement('tr');
                row.innerHTML = `
            <td>${dateStr}</td>
            <td>${timeStr}</td>
            <td>${stage}</td>
            <td>${N}</td>
            <td>${PP}</td>
            <td>${model}</td>
            <td>${baseName}</td>
            <td>${count}</td>
        `;

                tbody.appendChild(row);
            }
        }
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ–ø—Ä–æ—Å–∞ –¥–∞–Ω–Ω—ã—Ö –∏–∑ JSON
        async function plc_xy() {
            try {
                const res = await fetch('plc_XY');
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                const data = await res.json();

                if (!Array.isArray(data) || data.length === 0) {
                    console.warn("–ü—É—Å—Ç–æ–π –ø–∞–∫–µ—Ç XY");
                    return;
                }

                // 1. –ü–æ–∏—Å–∫ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π (–∫–∞–∫ —É —Ç–µ–±—è –±—ã–ª–æ)
                const find = (type, dec) => data.find(x => x.type === type && x.addr_dec === dec)?.val;

                const x24 = find("X", 20);
                const x25 = find("X", 21);
                const x22 = find("X", 18);
                const c102 = find("C", 102);
                const d4000 = find("D", 4000);
                console.log("X24", x24, "X25", x25, "X22", x22, "c102", c102, "d4000", d4000)
                if (x22) document.getElementById('_X22').textContent = "–¶–ï–ü–¨ –û–°–¢–ê–ù–û–í–õ–ï–ù–ê";
                else document.getElementById('_X22').textContent = "–¶–ï–ü–¨ –î–í–ò–ñ–ï–¢–°–Ø";
                document.getElementById('_X22').classList.toggle("active", !x22);
                document.getElementById('_X24').classList.toggle("active", !x24);
                document.getElementById('_X25').classList.toggle("active", !x25);
                // 2. –ú–∞—Å—Å–æ–≤–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ ID
                for (const item of data) {
                    // –§–æ—Ä–º–∏—Ä—É–µ–º ID —Ç–∞–∫ –∂–µ, –∫–∞–∫ –ø—Ä–∏ –æ—Ç—Ä–∏—Å–æ–≤–∫–µ (—Ç–∏–ø + –≤–æ—Å—å–º–µ—Ä–∏—á–Ω—ã–π –∞–¥—Ä–µ—Å)
                    // –ù–∞–ø—Ä–∏–º–µ—Ä: "X" + "10" = "X10"
                    const elementId = item.type + item.addr_oct;
                    const el = document.getElementById(elementId);

                    if (el) {
                        // !!item.val –ø—Ä–µ–≤—Ä–∞—â–∞–µ—Ç 1/0 –∏–ª–∏ –ª—é–±–æ–µ —á–∏—Å–ª–æ –≤ true/false
                        el.classList.toggle("active", !!item.val);
                    }
                }

                document.getElementById('C102').textContent = c102;
                document.getElementById('D4000').textContent = d4000;

                document.getElementById('chain-error').textContent = '';
            } catch (e) {
                console.error("–û—à–∏–±–∫–∞ –æ–ø—Ä–æ—Å–∞ —Ü–µ–ø–∏:", e);
                document.getElementById('chain-error').textContent = "–ù–µ—Ç —Å–≤—è–∑–∏ ¬∑ " + e.message;
            }
        }
        function update_all() {

        }

        document.getElementById('update-button').addEventListener('click', update_all);
        update();

        // –ü—Ä–∏–º–µ—Ä –ª–æ–≥–∏–∫–∏ –≤ —Å–∫—Ä–∏–ø—Ç–µ:
const pollCheckbox = document.getElementById('poll-x-checkbox');

function startPolling() {
    if (pollCheckbox.checked) {
        // —Ç–≤–æ–π –∫–æ–¥ –∑–∞–ø—É—Å–∫–∞ setInterval
        console.log("–û–ø—Ä–æ—Å –∑–∞–ø—É—â–µ–Ω –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é");
    }
}

// –í—ã–∑—ã–≤–∞–µ–º –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
startPolling();
    </script>
</body>

</html>
